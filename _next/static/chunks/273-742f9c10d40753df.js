"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[273],{6041:(t,e,a)=>{a.d(e,{e:()=>n});var n=function(t){return t.TODO="todo",t.IN_PROGRESS="in_progress",t.COMPLETED="completed",t}({})},6274:(t,e,a)=>{a.d(e,{G9:()=>s,I1:()=>i,J9:()=>r,kR:()=>d,qL:()=>l});var n=a(6041);function r(t,e){if(0===t.length)return"";if(1===t.length)return t[0].id;let a=t.map(t=>({userId:t.id,yesterdayMinutes:function(t,e){let a=new Date;a.setDate(a.getDate()-1);let n=a.toISOString().split("T")[0],r=e.find(e=>e.userId===t&&e.date===n);return(null==r?void 0:r.minutesWorked)||0}(t.id,e)})),n=Math.min(...a.map(t=>t.yesterdayMinutes)),r=a.filter(t=>t.yesterdayMinutes===n),o=Math.floor(Math.random()*r.length);return r[o].userId}function o(t){if(!t.startedAt||!t.completedAt)return 0;let e=new Date(t.startedAt).getTime();return Math.round((new Date(t.completedAt).getTime()-e)/6e4)}function s(t,e){let a=o(e);return{...t,totalCompletedTasks:t.totalCompletedTasks+1,totalMinutesWorked:t.totalMinutesWorked+a,lastActiveDate:new Date}}function l(t,e){let a=new Date().toISOString().split("T")[0],r=e.filter(e=>e.assignedTo===t&&e.status===n.e.COMPLETED&&e.completedAt&&new Date(e.completedAt).toISOString().split("T")[0]===a),s=r.reduce((t,e)=>t+o(e),0);return{date:a,userId:t,tasksCompleted:r.length,minutesWorked:s,tasks:r}}function i(t){let e=new Date,[a,n]=t.split(":").map(Number),r=new Date;return r.setHours(a,n,0,0),e>r}function d(t,e){let a=new Date,n=new Date(a);n.setDate(a.getDate()-a.getDay());let r=new Date(n);r.setDate(n.getDate()+6);let o=n.toISOString().split("T")[0],s=r.toISOString().split("T")[0],l={};return t.forEach(t=>{let a=e.filter(e=>e.userId===t.id&&e.date>=o&&e.date<=s);l[t.id]={tasksCompleted:a.reduce((t,e)=>t+e.tasksCompleted,0),minutesWorked:a.reduce((t,e)=>t+e.minutesWorked,0),dailyBreakdown:a}}),{weekStart:o,weekEnd:s,userStats:l}}},6747:(t,e,a)=>{a.d(e,{d:()=>n});class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}createRoom(t){let e=this.generateRoomId(),a={id:e,name:t,createdAt:new Date().toISOString(),lastActive:new Date().toISOString(),memberCount:1};return localStorage.setItem("room:".concat(e,":info"),JSON.stringify(a)),localStorage.setItem("room:".concat(e,":host"),this.getUserId()),this.updateURL(e),this.initializeRoom(e),e}joinRoom(t){let e=this.getRoomInfo(t);return!!e&&(e.lastActive=new Date().toISOString(),localStorage.setItem("room:".concat(t,":info"),JSON.stringify(e)),this.updateURL(t),this.initializeRoom(t),!0)}getRoomInfo(t){let e=localStorage.getItem("room:".concat(t,":info"));return e?JSON.parse(e):null}getCurrentRoomId(){return this.currentRoomId}getRoomShareLink(t){let e=t||this.currentRoomId;if(!e)return window.location.origin;let a=new URL(window.location.origin);return a.searchParams.set("room",e),a.toString()}async initializeRoom(t){this.currentRoomId=t,this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel("room:".concat(t)),this.broadcastChannel.onmessage=t=>{"data-sync"===t.data.type&&this.onDataChangeCallback&&this.onDataChangeCallback()},this.syncInterval&&clearInterval(this.syncInterval),this.syncInterval=setInterval(()=>{this.updateLastSeen()},3e4)}broadcastDataChange(){this.broadcastChannel&&this.currentRoomId&&this.broadcastChannel.postMessage({type:"data-sync",roomId:this.currentRoomId,timestamp:Date.now()})}onDataChange(t){this.onDataChangeCallback=t}updateLastSeen(){if(!this.currentRoomId)return;let t="room:".concat(this.currentRoomId,":member:").concat(this.getUserId()),e=this.getCurrentMember();e&&(e.lastSeen=new Date().toISOString(),e.isOnline=!0,localStorage.setItem(t,JSON.stringify(e)))}getCurrentMember(){if(!this.currentRoomId)return null;let t="room:".concat(this.currentRoomId,":member:").concat(this.getUserId()),e=localStorage.getItem(t);return e?JSON.parse(e):null}addMemberToRoom(t){if(!this.currentRoomId)throw Error("No active room");let e={id:this.getUserId(),name:t,joinedAt:new Date().toISOString(),lastSeen:new Date().toISOString(),isOnline:!0},a="room:".concat(this.currentRoomId,":member:").concat(e.id);return localStorage.setItem(a,JSON.stringify(e)),e}getRoomMembers(){if(!this.currentRoomId)return[];let t=[],e="room:".concat(this.currentRoomId,":member:");for(let a=0;a<localStorage.length;a++){let n=localStorage.key(a);if(n&&n.startsWith(e)){let e=localStorage.getItem(n);if(e){let a=JSON.parse(e),n=new Date(a.lastSeen);a.isOnline=new Date().getTime()-n.getTime()<3e5,t.push(a)}}}return t.sort((t,e)=>new Date(t.joinedAt).getTime()-new Date(e.joinedAt).getTime())}generateRoomId(){return Math.random().toString(36).substring(2,10).toUpperCase()}getUserId(){let t=localStorage.getItem("user:id");return t||(t="user_"+Math.random().toString(36).substring(2,15),localStorage.setItem("user:id",t)),t}updateURL(t){{let e=new URL(window.location.href);e.searchParams.set("room",t),window.history.replaceState({},"",e.toString())}}getConnectionStatus(){return{localSync:null!==this.broadcastChannel}}cleanup(){this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}constructor(){this.currentRoomId=null,this.broadcastChannel=null,this.syncInterval=null,this.onDataChangeCallback=null;{let t=new URLSearchParams(window.location.search);this.currentRoomId=t.get("room"),this.currentRoomId&&this.initializeRoom(this.currentRoomId)}}}},7273:(t,e,a)=>{a.d(e,{AppProvider:()=>g,n:()=>h});var n=a(5155),r=a(2115),o=a(6041),s=a(6747);function l(t){let e=s.d.getInstance(),a=t||e.getCurrentRoomId();return a?"room:".concat(a,":data"):"family-helper-data"}function i(t){try{let e=l();localStorage.setItem(e,JSON.stringify(t)),s.d.getInstance().broadcastDataChange()}catch(t){console.error("Error saving to local storage:",t)}}var d=a(6274);let c={data:null,isLoading:!0,error:null,roomId:null,isInRoom:!1};function u(t,e){switch(e.type){case"LOAD_DATA":return{...t,data:e.payload,isLoading:!1,error:null};case"ADD_TASK":{if(!t.data)return t;let a=[...t.data.tasks,e.payload],n={...t.data,tasks:a,lastSyncDate:new Date};return i(n),{...t,data:n}}case"UPDATE_TASK":{if(!t.data)return t;let a=t.data.tasks.map(t=>t.id===e.payload.id?{...t,...e.payload.updates}:t),n={...t.data,tasks:a,lastSyncDate:new Date};return i(n),{...t,data:n}}case"DELETE_TASK":{if(!t.data)return t;let a=t.data.tasks.filter(t=>t.id!==e.payload),n={...t.data,tasks:a,lastSyncDate:new Date};return i(n),{...t,data:n}}case"MOVE_TASK":{if(!t.data)return t;let a=t.data.tasks.find(t=>t.id===e.payload.id);if(!a)return t;let n={status:e.payload.status};e.payload.status===o.e.IN_PROGRESS?n.startedAt=new Date:e.payload.status===o.e.COMPLETED&&(n.completedAt=new Date,a.startedAt&&(n.actualMinutes=Math.round((new Date().getTime()-new Date(a.startedAt).getTime())/6e4)));let r=t.data.tasks.map(t=>t.id===e.payload.id?{...t,...n}:t),s=t.data.family,l=t.data.dailyStats;if(e.payload.status===o.e.COMPLETED&&a.assignedTo){let e={...a,...n};s={...t.data.family,members:t.data.family.members.map(t=>t.id===a.assignedTo?(0,d.G9)(t,e):t)};let o=(0,d.qL)(a.assignedTo,r),i=l.findIndex(t=>t.date===o.date&&t.userId===o.userId);i>=0?(l=[...l])[i]=o:l=[...l,o]}let c={...t.data,tasks:r,family:s,dailyStats:l,lastSyncDate:new Date};return i(c),{...t,data:c}}case"UPDATE_FAMILY":{if(!t.data)return t;let a={...t.data.family,...e.payload},n={...t.data,family:a,lastSyncDate:new Date};return i(n),{...t,data:n}}case"ADD_URGENT_REQUEST":{if(!t.data)return t;let a={...t.data,urgentRequests:[...t.data.urgentRequests,e.payload],lastSyncDate:new Date};return i(a),{...t,data:a}}case"UPDATE_URGENT_REQUEST":{if(!t.data)return t;let a=t.data.urgentRequests.map(t=>t.id===e.payload.id?{...t,status:e.payload.status}:t),n={...t.data,urgentRequests:a,lastSyncDate:new Date};return i(n),{...t,data:n}}case"SET_ROOM":return{...t,roomId:e.payload.roomId,isInRoom:e.payload.isInRoom};case"LEAVE_ROOM":return{...t,roomId:null,isInRoom:!1};default:return t}}let m=(0,r.createContext)(null);function g(t){let{children:e}=t,[a,o]=(0,r.useReducer)(u,c);(0,r.useEffect)(()=>{let t=s.d.getInstance(),e=t.getCurrentRoomId();e&&o({type:"SET_ROOM",payload:{roomId:e,isInRoom:!0}});let a=()=>{let t=function(){try{let t=l(),e=localStorage.getItem(t);if(!e)return null;let a=JSON.parse(e);return{...a,family:{...a.family,createdAt:new Date(a.family.createdAt),members:a.family.members.map(t=>({...t,lastActiveDate:new Date(t.lastActiveDate)}))},tasks:a.tasks.map(t=>({...t,createdAt:new Date(t.createdAt),startedAt:t.startedAt?new Date(t.startedAt):void 0,completedAt:t.completedAt?new Date(t.completedAt):void 0})),dailyStats:a.dailyStats.map(t=>({...t,tasks:t.tasks.map(t=>({...t,createdAt:new Date(t.createdAt),startedAt:t.startedAt?new Date(t.startedAt):void 0,completedAt:t.completedAt?new Date(t.completedAt):void 0}))})),urgentRequests:a.urgentRequests.map(t=>({...t,createdAt:new Date(t.createdAt)})),lastSyncDate:new Date(a.lastSyncDate)}}catch(t){return console.error("Error parsing local storage data:",t),null}}();t||(t=function(){let t={family:{id:"family-1",name:"胖虎之家",members:[{id:"user-1",name:"小吕",totalCompletedTasks:0,totalMinutesWorked:0,lastActiveDate:new Date},{id:"user-2",name:"小王",totalCompletedTasks:0,totalMinutesWorked:0,lastActiveDate:new Date}],workEndTime:"20:30",monthlyFund:0,createdAt:new Date},tasks:[],dailyStats:[],urgentRequests:[],lastSyncDate:new Date};return i(t),t}()),o({type:"LOAD_DATA",payload:t})};return t.onDataChange(()=>{a()}),a(),()=>{t.cleanup()}},[]);let g={addTask:t=>{o({type:"ADD_TASK",payload:{...t,id:"task-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),createdAt:new Date}})},updateTask:(t,e)=>{o({type:"UPDATE_TASK",payload:{id:t,updates:e}})},deleteTask:t=>{o({type:"DELETE_TASK",payload:t})},moveTask:(t,e)=>{o({type:"MOVE_TASK",payload:{id:t,status:e}})},updateFamily:t=>{o({type:"UPDATE_FAMILY",payload:t})},addUrgentRequest:t=>{o({type:"ADD_URGENT_REQUEST",payload:{...t,id:"urgent-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),createdAt:new Date}})},updateUrgentRequest:(t,e)=>{o({type:"UPDATE_URGENT_REQUEST",payload:{id:t,status:e}})},assignTaskAutomatically:t=>{if(!a.data)return;let e=(0,d.J9)(a.data.family.members,a.data.dailyStats);g.addTask({...t,assignedTo:e})}};return(0,n.jsx)(m.Provider,{value:{state:a,dispatch:o,actions:g},children:e})}function h(){let t=(0,r.useContext)(m);if(!t)throw Error("useApp must be used within an AppProvider");return t}}}]);